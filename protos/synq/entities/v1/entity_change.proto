syntax = "proto3";

package synq.entities.v1;

import "buf/validate/validate.proto";
import "google/protobuf/timestamp.proto";
import "synq/entities/v1/identifier.proto";

option go_package = "github.com/getsynq/api/entities/v1";

enum EntityChangeType {
  ENTITY_CHANGE_TYPE_UNSPECIFIED = 0;
  ENTITY_CHANGE_TYPE_GIT_COMMIT = 1;
  ENTITY_CHANGE_TYPE_SQL_DEFINITION_CHANGE = 2;
  ENTITY_CHANGE_TYPE_SCHEMA_CHANGE = 3;
}

// EntityChange represents a change detected in an entity within the system.
// It tracks modifications to entities like Git commits, SQL definitions, and database schemas.
message EntityChange {
  // Identifier of the entity on which the change was detected when available.
  Identifier entity_id = 1 [(buf.validate.field) = {required: true}];

  // SYNQ path representing entity on which the change was detected when available,
  optional string entity_synq_path = 5;

  // Identifiers of entities directly affected by this change.
  repeated Identifier affected_entities = 4;

  // SYNQ paths of entities directly affected by this change.
  repeated string affected_entities_synq_paths = 6;

  // Internal identifier of the change event.
  string change_id = 2 [(buf.validate.field) = {required: true}];

  // Timestamp when the change was detected by SYNQ.
  google.protobuf.Timestamp change_detected_at = 3 [(buf.validate.field) = {required: true}];

  oneof change_type {
    option (buf.validate.oneof).required = true;
    GitCommitChange git_commit = 10;
    SqlDefinitionChange sql_definition = 11;
    SchemaChange schema = 12;
  }
}

// GitCommitChange represents a change detected in a Git repository.
message GitCommitChange {
  // Signature contains information about the Git user who made the changes.
  message Signature {
    // Name of the Git user.
    string name = 1;
    // Email address of the Git user.
    string email = 2;
    // Timestamp when the signature was created.
    google.protobuf.Timestamp created_at = 3;
  }

  // ChangeStats contains statistics about changes made to a single file.
  message ChangeStats {
    // Number of lines added to the file.
    int32 additions = 1;
    // Number of lines removed from the file.
    int32 deletions = 2;
  }

  // TopFileChange represents a significant file change within a directory.
  message TopFileChange {
    // Path of the file relative to the directory.
    string file_path = 1;
    // Number of lines added.
    int32 lines_added = 2;
    // Number of lines removed.
    int32 lines_removed = 3;
  }

  // DirectoryChangeSummary provides hierarchical directory-level statistics.
  message DirectoryChangeSummary {
    // Path of the directory.
    string directory_path = 1;
    // Number of files changed in this directory (excluding subdirectories).
    int32 files_changed = 2;
    // Total lines added in this directory (excluding subdirectories).
    int32 total_lines_added = 3;
    // Total lines removed in this directory (excluding subdirectories).
    int32 total_lines_removed = 4;
    // Subdirectory summaries.
    repeated DirectoryChangeSummary subdirs = 5;
    // Top 3-5 most significant file changes in this directory.
    repeated TopFileChange top_files = 6;
  }

  // FileTypeChangeSummary aggregates changes by file type/extension.
  message FileTypeChangeSummary {
    // File extension (e.g., ".sql", ".py", ".yml").
    string file_extension = 1;
    // Number of files with this extension that were changed.
    int32 files_count = 2;
    // Total lines added across all files of this type.
    int32 total_lines_added = 3;
    // Total lines removed across all files of this type.
    int32 total_lines_removed = 4;
    // Example file paths (up to 5) showing where these changes occurred.
    repeated string example_files = 5;
    // Common directories where files of this type were modified.
    repeated string common_directories = 6;
  }

  // FileChangeDistribution categorizes files by change magnitude.
  message FileChangeDistribution {
    // Files with fewer than 10 lines changed.
    int32 files_with_small_changes = 1;
    // Files with 10-100 lines changed.
    int32 files_with_medium_changes = 2;
    // Files with more than 100 lines changed.
    int32 files_with_large_changes = 3;
    // Files that were newly added.
    int32 files_added = 4;
    // Files that were modified.
    int32 files_modified = 5;
    // Files that were deleted.
    int32 files_deleted = 6;
  }

  // TopChange represents one of the most significant file changes.
  message TopChange {
    // Path of the file.
    string file_path = 1;
    // Lines added.
    int32 lines_added = 2;
    // Lines removed.
    int32 lines_removed = 3;
    // Total lines changed (added + removed).
    int32 total_lines_changed = 4;
  }

  // ChangeStatistics provides statistical summaries of the entire commit.
  message ChangeStatistics {
    // Total number of files changed.
    int32 total_files = 1;
    // Total lines added across all files.
    int32 total_lines_added = 2;
    // Total lines removed across all files.
    int32 total_lines_removed = 3;
    // Distribution of changes by magnitude.
    FileChangeDistribution distribution = 4;
    // Top 10 files by total lines changed.
    repeated TopChange top_changes = 5;
  }

  // Hash of the Git commit.
  string hash = 1;

  // Author information of the Git commit.
  Signature author = 2;
  // Committer information of the Git commit.
  Signature committer = 3;

  // Commit message describing the changes.
  string message = 4;

  // First non-empty line of the message
  string short_message = 10;

  // Statistics about changes made to each modified file.
  map<string, ChangeStats> file_change_stats = 5;

  // All file paths changed in this commit (complete list).
  // For commits with many files, this may be a large array.
  repeated string changed_file_paths = 8;

  // File paths that directly affect the queried entity (filtered subset of changed_file_paths).
  // When querying changes for a specific entity (e.g., dbt model "customers"), this contains
  // only the files that directly impact that entity (e.g., "models/customers.sql", "models/staging/stg_customers.sql").
  // Empty when retrieving a change by change_id directly (not scoped to a specific entity).
  // Empty when it's impossible to determine entity-specific file mappings.
  // Example: If a commit changes 50 files but only 2 affect your queried dbt model, this contains those 2 files.
  repeated string related_changed_file_paths = 9;

  // Name of the branch associated with the commit, if any.
  optional string branch_name = 6;

  // URL of the Git repository where the commit was made.
  string clone_url = 7;

  // URL to e.g. Github which opens the Commit
  optional string web_commit_url = 11;

  // STRUCTURED METADATA (Phase 1 - Core):
  // These fields provide efficient, token-optimized representations of large commits.

  // Hierarchical directory summaries showing where changes occurred.
  repeated DirectoryChangeSummary directory_changes = 30;

  // Aggregated statistics by file type/extension.
  map<string, FileTypeChangeSummary> changes_by_file_type = 31;

  // Overall statistical summary of the commit.
  optional ChangeStatistics statistics = 34;
}

// SqlDefinitionChange represents a change detected in a SQL definition.
message SqlDefinitionChange {
  // Previous version of the SQL definition.
  string previous_sql = 1;
  // Timestamp when the previous SQL state was valid.
  google.protobuf.Timestamp previous_sql_state_at = 2;
  // Current version of the SQL definition.
  string current_sql = 3;
  // Timestamp when the current SQL state became valid.
  google.protobuf.Timestamp current_sql_state_at = 4;
  // Diff showing the changes between previous and current SQL.
  string sql_diff = 5;
}

// SchemaChange represents a change detected in a database schema.
message SchemaChange {
  // List of changes made to individual columns in the schema.
  repeated SchemaColumnChange column_changes = 1;
}

// SchemaColumnChange represents a specific change to a column in the schema.
message SchemaColumnChange {
  // ColumnRemovalChangeType represents the removal of a column from the schema.
  message ColumnRemovalChangeType {
    // Identifier of the removed column.
    string column_id = 1;
    // Native data type of the removed column.
    string native_type = 2;
    // Original position of the column in the schema.
    int32 ordinal_position = 3;
  }

  // ColumnNativeTypeChangeType represents a change in a column's data type.
  message ColumnNativeTypeChangeType {
    // Identifier of the modified column.
    string column_id = 1;
    // Previous data type of the column.
    string previous_native_type = 2;
    // New data type of the column.
    string current_native_type = 3;
  }

  // ColumnAdditionChangeType represents the addition of a new column to the schema.
  message ColumnAdditionChangeType {
    // Identifier of the new column.
    string column_id = 1;
    // Data type of the new column.
    string native_type = 2;
    // Position where the column was added in the schema.
    int32 ordinal_position = 3;
  }

  oneof column_change {
    ColumnAdditionChangeType column_addition = 1;
    ColumnNativeTypeChangeType column_native_type = 2;
    ColumnRemovalChangeType column_removal = 3;
  }
}
